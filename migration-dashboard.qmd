---
title: Composition API Migration Dashboard
format:
  dashboard
---

```{r setup}
library(dplyr)
library(glue)
library(httr2)
library(jsonlite)
library(kableExtra)
library(knitr)
library(purrr)
library(stringr)
library(tibble)

GITHUB_API_HOST <- 'https://api.github.com'
GITHUB_API_KEY <- Sys.getenv("GITHUB_API_KEY")
GITHUB_SEARCH_PATH <- 'search/code'
GITHUB_USER <- Sys.getenv("GITHUB_USER")

get_names_from_git_response <- function(item) {
  item$path |> str_replace('ui/dashboard/src/', '')
}

request_all_pages <- function(search_str) {
  query <- glue('"{search_str}"+language:Vue+in:file+repo:rstudio/connect')
  agg_results <- request(GITHUB_API_HOST) |> 
    req_url_path(GITHUB_SEARCH_PATH) |>
    req_url_query(
      q = I(query),
      per_page = 100
    ) |> 
    req_auth_basic(GITHUB_USER, GITHUB_API_KEY) |>
    req_perform() |>
    resp_body_json()

}

render_table <- function(component_list) {
  data.frame(Components = unlist(component_list)) |>
    as_tibble() |>
    arrange(Components) |>
    kbl() |>
    kable_styling()
}
```

```{r composition-components}
composition_results <- request_all_pages("script%20setup")

composition_count <- composition_results$total_count
composition_components <- composition_results$items |>
  map(get_names_from_git_response)
```

```{r option-components}
resp_options_vue <- request_all_pages("export%20default%20{")

vue_options_total <- resp_options_vue$total_count
option_components <- resp_options_vue$items |>
  map(get_names_from_git_response)
```

::: {.callout-warning}
## Work In Progress

The Composition API count appears to be accurate, but the Options API count is unconfirmed. The list of components is not really working at the moment.
:::

## Row

```{r}
#| content: valuebox
#| title: "Composition API Components"
#| icon: check
#| color: primary

composition_count
```

```{r}
#| content: valuebox
#| title: "Options API Components"
#| icon: hourglass
#| color: warning

vue_options_total
```

## Row {.tabset}

```{r}
#| title: "Composition API"

composition_components |> render_table()
```

```{r}
#| title: Options API

option_components |> render_table()
```
